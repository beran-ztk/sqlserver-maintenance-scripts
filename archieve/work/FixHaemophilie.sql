	USE Apobase;

	DECLARE @HämoTable TABLE (E nvarchar(25)) INSERT @HämoTable (E)
	SELECT DISTINCT r.ERezeptID AS ID
	FROM RW_APOBASE_Rezept r 
	LEFT JOIN RW_EREZEPT_RZErgebnis rz ON r.ERezeptID = rz.ERezeptID
	WHERE cKontrollStatus IN (3,4) AND r.ERezeptID IS NOT NULL AND bstorno = 0 AND iRpNr > 0 
	  AND r.ERezeptID IN (SELECT ERezeptID FROM rw_apobase_rezept WHERE ERezeptID IS NOT NULL AND dipzn NOT IN ((9999175), (9999637), (9999005), (9999057), (2567024), (6461110), (2567001), (2567018), (8000001), (9999643)) 
		  GROUP BY ERezeptID HAVING COUNT(ERezeptID) = 2);

	DECLARE @HämoERezeptID NVARCHAR(25);

	DECLARE HämoCursor CURSOR FOR
	SELECT E FROM @HämoTable;

	OPEN HämoCursor;
	FETCH NEXT FROM HämoCursor INTO @HämoERezeptID;

	WHILE @@FETCH_STATUS = 0
		BEGIN
			DECLARE @HämoPZN INT = (SELECT TOP 1 diPzn FROM RW_APOBASE_REZEPT WHERE ERezeptID = @HämoERezeptID AND diPzn NOT IN ((9999175), (9999637), (9999005), (9999057), (2567024), (6461110), (2567001), (2567018), (8000001), (9999643)));
			DECLARE @HämoERP NVARCHAR(25) = (SELECT DISTINCT(ERezeptID) FROM RW_APOBASE_Rezept  
			WHERE diPzn = @HämoPZN AND ERezeptID = @HämoERezeptID AND dipzn NOT IN ((9999175), (9999637), (9999005), (9999057), (2567024), (6461110), (2567001), (2567018), (8000001), (9999643)) 
				 GROUP BY ERezeptID HAVING COUNT(ERezeptID) = 2);
			DECLARE @HämoLFD INT = (SELECT TOP 1 dilfdnr from RW_APOBASE_Rezept WHERE diPzn = @HämoPZN AND ERezeptID = @HämoERezeptID AND dipzn NOT IN ((9999175), (9999637), (9999005), (9999057), (2567024), (6461110), (2567001), (2567018), (8000001), (9999643)));

			UPDATE RW_APOBASE_Rezept set iRpNr = 0, ERezeptID = null WHERE diLfdNr = @HämoLFD;

			FETCH NEXT FROM HämoCursor INTO @HämoERezeptID;
		END

	CLOSE HämoCursor;
	DEALLOCATE HämoCursor;